{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 700,
  "height": 400,
  "data": {
    "url": "Homework10_dataset.csv"
  },
  "params": [
    {
      "name": "year_start",
      "value": 2000,
      "bind": {
        "input": "range",
        "min": 2000,
        "max": 2023,
        "step": 1,
        "name": "Start Year:"
      }
    },
    {
      "name": "year_end",
      "value": 2023,

      "bind": {
        "input": "range",
        "min": 2000,
        "max": 2023,
        "step": 1,
        "name": "End Year:"
      }
    },
    {
      "name": "state_dropdown",
      "value": "All",
      "bind": {
        "input": "select",
        "options": [
          "All",
          "Johor",
          "Kedah",
          "Kelantan",
          "Malacca",
          "Negeri Sembilan",
          "Pahang",
          "Penang",
          "Perak",
          "Perlis",
          "Sabah",
          "Sarawak",
          "Selangor",
          "Terengganu",
          "Kuala Lumpur",
          "Putrajaya",
          "Labuan"
        ],
        "name": "Select State:"
      }
    },
    {
      "name": "state_select",
      "select": {"type": "point", "fields": ["state_str"], "on": "click"},
      "bind": "legend"
    }
  ],
  "transform": [
    {
      "calculate": "datetime(+split(datum.date, '/')[2], +split(datum.date, '/')[0]-1, +split(datum.date, '/')[1])",
      "as": "date_parsed"
    },
    { "calculate": "year(datum.date_parsed)", "as": "year" },
    { "calculate": "toNumber(datum.population) * 1000", "as": "population_num" },
    { "calculate": "datum.state", "as": "state_str" },

    { "filter": "datum.sex == 'both'" },
    { "filter": "datum.ethnicity == 'chinese' || datum.ethnicity == 'indian' || datum.ethnicity == 'bumi_malay'" },
    { "filter": "datum.year >= year_start && datum.year <= year_end" },
    { "filter": "state_dropdown == 'All' ? true : datum.state_str == state_dropdown" },

    {
      "aggregate": [
        {"op": "sum", "field": "population_num", "as": "total_population"}
      ],
      "groupby": ["year", "state_str"]
    }
  ],
  "mark": {
    "type": "line",
    "point": true,
    "interpolate": "monotone"
  },
  "encoding": {
    "x": { "field": "year", "type": "ordinal", "title": "Year" },
    "y": { "field": "total_population", "type": "quantitative", "title": "Total Population" },
    "color": {
      "field": "state_str",
      "type": "nominal",
      "title": "State",
      "legend": {"orient": "right", "title": "Click to filter"}
    },
    "opacity": {
      "condition": {"param": "state_select", "value": 1},
      "value": 0.15
    },
    "tooltip": [
      {"field": "state_str", "title": "State"},
      {"field": "year", "title": "Year"},
      {
        "field": "total_population",
        "title": "Total Population",
        "format": ","
      }
    ]
  }
}
